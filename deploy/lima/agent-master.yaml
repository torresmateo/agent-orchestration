# Lima VM template for agent-master golden image
# This is the static reference copy. The actual template used is
# rendered by `agentctl master create` to ~/.agentvm/agent-master.yaml
# with user-specific paths substituted.

vmType: vz
os: Linux
arch: aarch64

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 2
memory: "3GiB"
disk: "30GiB"

networks:
  - vzNAT: true

mountType: virtiofs
mounts:
  - location: "~/.agentvm/shared"
    mountPoint: "/mnt/host-shared"
    writable: false

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux
      for i in $(seq 1 30); do
        if ping -c1 -W2 archive.ubuntu.com >/dev/null 2>&1; then break; fi
        sleep 2
      done
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y \
        ca-certificates curl gnupg lsb-release \
        git jq unzip build-essential \
        apt-transport-https software-properties-common
      # Docker CE
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      usermod -aG docker ${LIMA_CIDATA_USER:-lima}
      # Node.js 22
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs
      # GitHub CLI
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
      apt-get update
      apt-get install -y gh
      # Agent harness
      if [ -f /mnt/host-shared/bin/agent-harness ]; then
        cp /mnt/host-shared/bin/agent-harness /usr/local/bin/agent-harness
        chmod +x /usr/local/bin/agent-harness
      fi
      mkdir -p /etc/agent-config
      cat > /etc/systemd/system/agent-harness.service <<'UNIT'
      [Unit]
      Description=Agent Harness Daemon
      After=network-online.target docker.service
      Wants=network-online.target
      [Service]
      Type=simple
      EnvironmentFile=-/etc/agent-config/env
      ExecStart=/usr/local/bin/agent-harness
      Restart=on-failure
      RestartSec=5
      StandardOutput=journal
      StandardError=journal
      [Install]
      WantedBy=multi-user.target
      UNIT
      systemctl daemon-reload
      systemctl enable agent-harness.service

  - mode: boot
    script: |
      #!/bin/bash
      set -eu
      for i in $(seq 1 30); do
        if ping -c1 -W2 host.lima.internal >/dev/null 2>&1; then break; fi
        sleep 2
      done
      if [ -f /mnt/host-shared/bin/agent-harness ]; then
        cp /mnt/host-shared/bin/agent-harness /usr/local/bin/agent-harness
        chmod +x /usr/local/bin/agent-harness
      fi
      if [ -f /etc/agent-config/task.json ]; then
        systemctl restart agent-harness.service
      fi
